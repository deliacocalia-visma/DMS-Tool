name: Configure DMS Jobs

on:
  push:
    branches:
      - main

env:
  AWS_REGION: eu-west-1
  AWS_OPENID_CONNECT_PROVIDER_ARN: arn:aws:iam::124523898468:oidc-provider/token.actions.githubusercontent.com
  AWS_ROLE_ARN: arn:aws:iam::124523898468:role/DMS-GITHUB-TEST
  REPLICATION_INSTANCE_ARN: arn:aws:dms:eu-west-1:124523898468:rep:YH2AHWJ5IAPUWXJ6NEG62B6ITUEC7BCKQ6RZDYY
  SOURCE_ENDPOINT_ARN: arn:aws:dms:eu-west-1:124523898468:endpoint:GWGREXCRDWOPRYDQKRS7A4S2SM7NZADOCMV4VDA
  TARGET_ENDPOINT_ARN: arn:aws:dms:eu-west-1:124523898468:endpoint:EPBDPPQSIC76SYPPBHFN24XELWY3AX5ESD5J33Y
  SOURCE_SCHEMA_NAME: tripletex
  TARGET_SCHEMA_NAME: globaldata
  TABLE_NAME: tripletexcompany

jobs:
  deploy:
    permissions: write-all
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10' # install the python version needed
          
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_ROLE_ARN }}

      - name: install python packages
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: execute py script # run main.py
        run: python main.py
